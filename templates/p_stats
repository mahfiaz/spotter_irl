<!DOCTYPE html>
<meta charset="utf-8"/>
<html lang="en">
	<head>
		
		<title>Spotter IRL Base</title>

		<link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="http://getbootstrap.com/examples/jumbotron-narrow/jumbotron-narrow.css" rel="stylesheet">

		<style type="text/css">
			/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */img,legend{border:0}legend,td,th{padding:0}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,optgroup,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre,textarea{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}table{border-collapse:collapse;border-spacing:0}

			body {
				background-image: url("/css_dust2.jpg");
				background-size: cover;

			}

			.form-control {
				background-color:#ab4621;
			}

			.textarea {
				color: white;
				font-weight: bold;
				width: 100%;
				background-color: #000000;
				opacity: 0.65;
				border-radius: 5px;
				padding: 5px;
			}

			.bottom {
				position: absolute;
				bottom: 0;
			}
		</style>

		<script type="text/javascript">
			

			function getStats() {
				var xhrStats = new XMLHttpRequest();
				var stats = "";
				var user = "";
				var divContents = "";

				xhrStats.open("GET", "/user", true);
				xhrStats.send();
				xhrStats.onreadystatechange = function() {
					if (xhrStats.readyState == 4 && xhrStats.state == 200) {
						user = xhrStats.responseText;
					}
				}

				xhrStats.open("GET", "/stats", true);
				xhrStats.send();
				xhrStats.onreadystatechange = function() {
					if (xhrStats.readyState == 4 && xhrStats.status == 200) {
						stats = xhrStats.responseText;
						stats = JSON.parse(stats);
						if(stats["roundName"] != null) {
							var statsDiv = document.getElementById("stats");
							divContents = "<table style='width:100%;'><tr><th></th><th>Tabatud</th><th>Puude</th><th>Miinus</th><th>Skoor</th></tr>";
							for(i in stats["teams"]) {
								team = stats["teams"][i];
								divContents += "<tr style='color:#"+team["color"]+";'><th>"+team["name"]+"</th><th>"+team["spotCount"]+"</th><th>"+team["touchCount"]+"</th><th>"+team["disloyality"]+"</th><th>"+team["score"]+"</th></tr>";
								for (i in team["players"]) {
									player = team["players"][i];
									if (player["name"] == user) {
										divContents += "<tr style='color:#"+team["color"]+";'><td>"+player["name"]+"</td><td>"+player["spotCount"]+"</td><td>"+player["touchCount"]+"</td><td>p"+ayer["disloyality"]+"</td><td>"+player["score"]+"</td></tr></table>";
									}
								}
							}
							for(i in stats["teamlessPlayers"]) {
								player = stats["teamlessPlayers"][i];
								if(player["name"] == user) {
									divContents += "<tr><td>"+player["name"]+"</td><td>"+player["spotCount"]+"</td><td>"+player["touchCount"]+"</td><td>p"+ayer["disloyality"]+"</td><td>"+player["score"]+"</td></tr></table>";
								}
							}
							divContents += "<div class='bottom' id='toEnd'></div>";
							statsDiv.innerHTML = divContents;
						}

					}
				}
			}


			function getEvents() {
				var xhrEvents = new XMLHttpRequest();
				var events = "";
				var user = "";
				var divContents = "";

				xhrEvents.open("GET", "/user", true);
				xhrEvents.send();
				xhrEvents.onreadystatechange = function() {
					if (xhrEvents.readyState == 4 && xhrEvents.state == 200) {
						user = xhrEvents.responseText;
					}
				}

				xhrEvents.open("GET", "/events", true);
				xhrEvents.send();
				xhrEvents.onreadystatechange = function() {
					if (xhrEvents.readyState == 4 && xhrEvents.status == 200) {
						events = xhrEvents.responseText;
						events = JSON.parse(events);
						if("event" in events[0]) {
							console.log("No events to show");
						} else {
							var eventsDiv = document.getElementById("events");
							for(i in events) {
								event = events[i];
								divContents += "<p>"+event["time"]+" <span style='color:#"+event["text1"]["color"]+";'>"+event["text1"]["text"]+"</span> <span style='color:#"+event["text2"]["color"]+";'>"+event["text2"]["text"]+"</span> <span style='color:#"+event["text3"]["color"]+";'>"+event["text3"]["text"]+"</span></p>";
							}
							eventsDiv.innerHTML = divContents;
						}

					}
				}
			}

			function timeToEnd() {
				var xhrTime = new XMLHttpRequest();
				currentDate = new Date();
				xhrTime.open("GET", "/stats", true);
				xhrTime.send();
				xhrTime.onreadystatechange = function() {
					if (xhrTime.readyState == 4 && xhrTime.status == 200) {
						stats = xhrTime.responseText;
						stats = JSON.parse(stats);
						if(stats["roundName"] != null) {
							var ending = stats["roundEnd"];
							endTime = new Date(ending.substring(0,4),ending.substring(5,7),ending.substring(8,10),ending.substring(11,13),ending.substring(14,16),ending.substring(17,19));
							var timeDiv = document.getElementById("toEnd");
							var toEnd = new Date(endTime.getTime() - currentDate.getTime());
							var divContents = "Aega vooru l√µpuni " + addZerobefore(toEnd.getUTCHours()) + ":" + addZerobefore(toEnd.getUTCMinutes()) + ":" + addZerobefore(toEnd.getUTCSeconds());
							timeDiv.innerHTML = divContents;
						}
					}
				}

			}

			
			function addZerobefore(number) {
				if(parseInt(number) < 10 && parseInt(number) > -10) {
					number = "0" + parseInt(number);
				}
				return number;
			}

			window.onload = function() {
				getEvents();
				getStats();
				timeToEnd();
				window.setInterval(function() {
					getStats();
					getEvents();
					timeToEnd();
				}, 4000);
				window.setInterval(function() {
					timeToEnd();
				}, 1000);
			}

			function tag() {
				console.log("Tagged someone");
			}

			function message() {
				console.log("Messaged team");
			}

		</script>

	</head>
	<body>
		<div class="sm-col-12">
			<div class="col-sm-10 col-sm-offset-1">
				<p>
					<div class="textarea" style="text-align:center; font-size:200%; min-height: 6vh;"></div>
				</p>
				<p>
					<div id="stats" class="textarea" style="min-height:20vh; max-height:20vh; overflow:scroll; position: relative;">
						<div class="bottom" id="toEnd"></div>
					</div>
				</p>
				<p>
					<div id="events" class="textarea" style="min-height:30vh; max-height:30vh; overflow:scroll;"></div>
				</p>
				<p style="text-align:center;">
					<input class="form-control" id="fleeingCode" type="text" placeholder="Silmasin koodi">
					<button class="btn-sm btn-danger btn-block" type="button" value="Taba" onclick="tag()">Taba</button>
				</p>
				<p style="text-align:center;width: 100%">
					<input class="form-control" id="fleeingCode" type="text" placeholder="Teade">
					<button class="btn-sm btn-danger btn-block" type="button" value="Saada" onclick="message()">Teade meeskonnale</button>
				</p>
			</div>
		</div>
	</body>
</html>